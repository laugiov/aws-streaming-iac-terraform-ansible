load_module modules/ngx_rtmp_module.so;
worker_processes auto;
events { worker_connections 1024; }

rtmp {
    server {
        listen 1935;
        chunk_size 4096;
        application live {
            live on;
            hls on;
            hls_path {{ hls_path }};
            hls_fragment 4s;
            hls_playlist_length 30s;
        }
    }
}

http {
    server {
        listen 80;
        server_name {{ domain_fqdn }};
        {% if cert_ready %}
          return 301 https://$host$request_uri;
        {% else %}
          location / { root /usr/share/nginx/html; index index.html; }
        {% endif %}
    }

    {% if cert_ready %}
    server {
        listen 443 ssl;
        server_name {{ domain_fqdn }};
        ssl_certificate     /etc/letsencrypt/live/{{ domain_fqdn }}/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/{{ domain_fqdn }}/privkey.pem;

        location / { root /usr/share/nginx/html; index index.html; }

        location /hls/  {
            types { application/vnd.apple.mpegurl m3u8; }
            alias {{ hls_path }}/;
        }

        location /dash/ {
            alias {{ dash_path }}/;
        }
    }
    {% endif %}
}
